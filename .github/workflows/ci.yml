name: CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    name: Build and Verify
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Build
        run: npm run build
      
      - name: Check for uncommitted changes
        run: |
          if [ -n "$(git status --porcelain dist/)" ]; then
            echo "ERROR: dist/ has uncommitted changes after build"
            echo "Please run 'npm run build' and commit the changes"
            git status --porcelain dist/
            exit 1
          fi

  test-minikube-functionality:
    runs-on: ubuntu-latest
    name: Test Minikube Functionality
    needs: build
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Check initial state
        run: |
          echo "=== Checking Initial System State ==="
          ! which minikube && echo "✓ minikube not installed initially" || (echo "✗ minikube already installed" && exit 1)
          docker ps && echo "✓ Docker is working" || (echo "✗ Docker not working" && exit 1)
          
      - name: Setup Minikube
        id: minikube
        uses: ./
        with:
          version: 'stable'
          kubernetes-version: 'stable'
          driver: 'docker'
          wait-for-ready: 'true'
          timeout: '300'
      
      - name: Verify Minikube is installed and running
        run: |
          echo "=== Verifying Minikube Installation ==="
          which minikube && echo "✓ minikube binary found at $(which minikube)" || (echo "✗ minikube binary not found" && exit 1)
          minikube status && echo "✓ minikube cluster is running" || (echo "✗ minikube not running" && exit 1)
      
      - name: Test kubectl access
        env:
          KUBECONFIG: ${{ steps.minikube.outputs.kubeconfig }}
        run: |
          echo "=== Testing Kubernetes Functionality ==="
          kubectl version --client
          kubectl cluster-info
          kubectl get nodes -o wide
          kubectl get pods -A
          
      - name: Deploy test workload
        env:
          KUBECONFIG: ${{ steps.minikube.outputs.kubeconfig }}
        run: |
          echo "=== Deploying Test Workload ==="
          
          kubectl create deployment nginx --image=nginx:alpine
          kubectl expose deployment nginx --port=80 --type=ClusterIP
          kubectl wait --for=condition=available --timeout=120s deployment/nginx
          
          # Test connectivity
          POD_NAME=$(kubectl get pod -l app=nginx -o jsonpath='{.items[0].metadata.name}')
          kubectl exec $POD_NAME -- wget -O- http://localhost:80 | grep -q "Welcome to nginx"
          echo "✓ Workload is functioning correctly"
          
      # NOTE: Cleanup runs automatically via post: hook after this job completes
      
  # Job 2: CRITICAL TEST - Verify cleanup worked by running the action again
  test-cleanup-restoration:
    runs-on: ubuntu-latest
    name: Verify Cleanup Restores System State
    needs: test-minikube-functionality
    if: always()
    
    steps:
      - uses: actions/checkout@v4
        
      - name: Verify Docker still works BEFORE running minikube
        run: |
          echo "=== CRITICAL TEST: Verifying Docker Works After Previous Cleanup ==="
          echo "This proves cleanup from the previous job didn't break Docker"
          echo ""
          
          # Docker should still work normally
          if ! docker ps >/dev/null 2>&1; then
            echo "✗ CRITICAL FAILURE: 'docker ps' does not work"
            echo "This means the previous job's cleanup broke Docker!"
            exit 1
          fi
          echo "✓ Docker is working"
          
          # Try running a container
          if ! docker run --rm hello-world 2>&1 | grep -q "Hello from Docker"; then
            echo "✗ CRITICAL FAILURE: Cannot run Docker containers"
            exit 1
          fi
          echo "✓ Docker can run containers"
        
      - name: Verify no minikube remnants from previous job
        run: |
          echo "=== Verifying Previous Cleanup Was Complete ==="
          
          # minikube binary should be removed
          if which minikube >/dev/null 2>&1; then
            echo "✗ CRITICAL FAILURE: minikube binary still exists at $(which minikube)"
            echo "This means the previous job's cleanup did NOT remove the binary!"
            exit 1
          fi
          echo "✓ minikube binary removed"
          
          # minikube profile should not exist
          if [ -d ~/.minikube ]; then
            echo "✗ CRITICAL FAILURE: ~/.minikube directory still exists"
            echo "This means the previous job's cleanup did NOT remove the profile!"
            ls -la ~/.minikube || true
            exit 1
          fi
          echo "✓ minikube profile removed"
          
          echo ""
          echo "=========================================="
          echo "✓✓✓ SUCCESS: CLEANUP RESTORED SYSTEM ✓✓✓"
          echo "=========================================="
          
      - name: Run minikube again to prove it works after cleanup
        id: minikube
        uses: ./
        with:
          version: 'stable'
          kubernetes-version: 'stable'
          driver: 'docker'
          timeout: '300'
        
      - name: Verify second minikube instance works
        env:
          KUBECONFIG: ${{ steps.minikube.outputs.kubeconfig }}
        run: |
          echo "=== Verifying Second Minikube Installation Works ==="
          kubectl get nodes
          kubectl get pods -A
          kubectl create deployment nginx --image=nginx:alpine
          kubectl wait --for=condition=available --timeout=120s deployment/nginx
          echo "✓ Second minikube instance is fully functional"
          
      # Cleanup will run automatically again for this job
      
  # Job 3: FINAL TEST - Run a pure Docker workflow after everything
  test-docker-after-multiple-runs:
    runs-on: ubuntu-latest
    name: Verify Docker Works After Multiple Minikube Runs
    needs: test-cleanup-restoration
    if: always()
    
    steps:
      - name: FINAL TEST - Verify Docker is fully functional
        run: |
          echo "=== FINAL TEST: Docker After Multiple Minikube Runs ==="
          echo "This simulates a workflow that needs Docker after minikube has been used"
          echo ""
          
          # Check Docker service
          if ! systemctl is-active docker >/dev/null 2>&1; then
            echo "✗ FAIL: Docker service not active"
            systemctl status docker || true
            exit 1
          fi
          echo "✓ Docker service is active"
          
          # Pull and run a container
          echo "Pulling nginx:alpine..."
          docker pull nginx:alpine
          
          echo "Running container..."
          CONTAINER_ID=$(docker run -d -p 8080:80 nginx:alpine)
          echo "Started container: $CONTAINER_ID"
          
          # Wait and test
          sleep 3
          curl -f http://localhost:8080 >/dev/null 2>&1 || (echo "✗ Container not responding" && exit 1)
          echo "✓ Container is responding"
          
          # Cleanup
          docker stop $CONTAINER_ID >/dev/null
          docker rm $CONTAINER_ID >/dev/null
          
          # Verify no minikube artifacts
          echo ""
          echo "=== Verifying No Minikube Artifacts ==="
          if which minikube >/dev/null 2>&1; then
            echo "✗ FAIL: minikube binary still exists"
            exit 1
          fi
          echo "✓ No minikube binary"
          
          if [ -d ~/.minikube ]; then
            echo "✗ FAIL: ~/.minikube still exists"
            exit 1
          fi
          echo "✓ No minikube profile directory"
          
          echo ""
          echo "=========================================="
          echo "✓✓✓ COMPLETE SUCCESS ✓✓✓"
          echo "=========================================="
          echo ""
          echo "The setup-minikube action:"
          echo "  ✓ Installs and runs minikube successfully"
          echo "  ✓ Properly configures Kubernetes cluster"
          echo "  ✓ Completely restores system state after cleanup"
          echo "  ✓ Can be run multiple times without issues"
          echo "  ✓ Allows subsequent workflows to use Docker normally"
          echo "  ✓ Leaves no artifacts after cleanup"
          echo ""
          echo "System state restoration is PERFECT!"
