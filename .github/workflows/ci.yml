name: CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    name: Build and Verify
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Build
        run: npm run build
      
      - name: Check for uncommitted changes
        run: |
          if [ -n "$(git status --porcelain dist/)" ]; then
            echo "ERROR: dist/ has uncommitted changes after build"
            echo "Please run 'npm run build' and commit the changes"
            git status --porcelain dist/
            exit 1
          fi

  test-minikube-functionality:
    runs-on: self-hosted
    name: Test Minikube Functionality
    needs: build
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Check initial state
        run: |
          echo "=== Checking Initial System State ==="
          # Note: ubuntu-latest comes with minikube pre-installed at /usr/local/bin/minikube
          # Our action installs to ~/.local/bin/minikube which takes priority via PATH
          if [ -f ~/.local/bin/minikube ]; then
            echo "✗ Custom minikube already exists at ~/.local/bin/minikube"
            exit 1
          fi
          echo "✓ No custom minikube binary in ~/.local/bin"
          
      - name: Setup Minikube
        id: minikube
        uses: ./
        with:
          version: 'stable'
          kubernetes-version: 'stable'
          wait-for-ready: 'true'
          timeout: '300'
      
      - name: Verify Minikube is installed and running
        run: |
          echo "=== Verifying Minikube Installation ==="
          which minikube && echo "✓ minikube binary found at $(which minikube)" || (echo "✗ minikube binary not found" && exit 1)
          minikube status && echo "✓ minikube cluster is running" || (echo "✗ minikube not running" && exit 1)
      
      - name: Test kubectl access
        env:
          KUBECONFIG: ${{ steps.minikube.outputs.kubeconfig }}
        run: |
          echo "=== Testing Kubernetes Functionality ==="
          kubectl version --client
          kubectl cluster-info
          kubectl get nodes -o wide
          kubectl get pods -A
          
      - name: Deploy test workload
        env:
          KUBECONFIG: ${{ steps.minikube.outputs.kubeconfig }}
        run: |
          echo "=== Deploying Test Workload ==="
          
          kubectl create deployment nginx --image=nginx:alpine
          kubectl expose deployment nginx --port=80 --type=ClusterIP
          kubectl wait --for=condition=available --timeout=120s deployment/nginx
          
          # Test connectivity
          POD_NAME=$(kubectl get pod -l app=nginx -o jsonpath='{.items[0].metadata.name}')
          kubectl exec $POD_NAME -- wget -O- http://localhost:80 | grep -q "Welcome to nginx"
          echo "✓ Workload is functioning correctly"
          
      # NOTE: Cleanup runs automatically via post: hook after this job completes
      
  # Job 2: CRITICAL TEST - Verify cleanup worked by running the action again
  test-cleanup-restoration:
    runs-on: self-hosted
    name: Verify Cleanup Restores System State
    needs: test-minikube-functionality
    if: always()
    
    steps:
      - uses: actions/checkout@v4
        
      - name: Verify system is clean BEFORE running minikube
        run: |
          echo "=== CRITICAL TEST: Verifying System is Clean After Previous Cleanup ==="
          echo "This proves cleanup from the previous job worked correctly"
          echo ""
          
          # Check for any minikube containers or processes
          if pgrep -f minikube >/dev/null 2>&1; then
            echo "✗ CRITICAL FAILURE: minikube processes still running"
            echo "This means the previous job's cleanup didn't stop all processes!"
            pgrep -af minikube || true
            exit 1
          fi
          echo "✓ No minikube processes running"
        
      - name: Verify no minikube remnants from previous job
        run: |
          echo "=== Verifying Previous Cleanup Was Complete ==="
          
          # Custom minikube binary should be removed
          if [ -f ~/.local/bin/minikube ]; then
            echo "✗ CRITICAL FAILURE: Custom minikube binary still exists at ~/.local/bin/minikube"
            echo "This means the previous job's cleanup did NOT remove the binary!"
            exit 1
          fi
          echo "✓ Custom minikube binary removed"
          
          # minikube profile should not exist
          if [ -d ~/.minikube ]; then
            echo "✗ CRITICAL FAILURE: ~/.minikube directory still exists"
            echo "This means the previous job's cleanup did NOT remove the profile!"
            ls -la ~/.minikube || true
            exit 1
          fi
          echo "✓ minikube profile removed"
          
          echo ""
          echo "=========================================="
          echo "✓✓✓ SUCCESS: CLEANUP RESTORED SYSTEM ✓✓✓"
          echo "=========================================="
          
      - name: Run minikube again to prove it works after cleanup
        id: minikube
        uses: ./
        with:
          version: 'stable'
          kubernetes-version: 'stable'
          timeout: '300'
        
      - name: Verify second minikube instance works
        env:
          KUBECONFIG: ${{ steps.minikube.outputs.kubeconfig }}
        run: |
          echo "=== Verifying Second Minikube Installation Works ==="
          kubectl get nodes
          kubectl get pods -A
          kubectl create deployment nginx --image=nginx:alpine
          kubectl wait --for=condition=available --timeout=120s deployment/nginx
          echo "✓ Second minikube instance is fully functional"
          
      # Cleanup will run automatically again for this job
      
  # Job 3: FINAL TEST - Verify system is clean after everything
  test-system-after-multiple-runs:
    runs-on: self-hosted
    name: Verify System Clean After Multiple Minikube Runs
    needs: test-cleanup-restoration
    if: always()
    
    steps:
      - name: FINAL TEST - Verify system is fully restored
        run: |
          echo "=== FINAL TEST: System After Multiple Minikube Runs ==="
          echo "This verifies the system is completely clean after multiple runs"
          echo ""
          
          # Verify no minikube processes
          if pgrep -f minikube >/dev/null 2>&1; then
            echo "✗ FAIL: minikube processes still running"
            pgrep -af minikube || true
            exit 1
          fi
          echo "✓ No minikube processes"
          
          # Verify no minikube artifacts
          echo ""
          echo "=== Verifying No Minikube Artifacts ==="
          if [ -f ~/.local/bin/minikube ]; then
            echo "✗ FAIL: Custom minikube binary still exists at ~/.local/bin/minikube"
            exit 1
          fi
          echo "✓ No custom minikube binary"
          
          if [ -d ~/.minikube ]; then
            echo "✗ FAIL: ~/.minikube still exists"
            exit 1
          fi
          echo "✓ No minikube profile directory"
          
          # Check for leftover containers (if any)
          if command -v crictl >/dev/null 2>&1; then
            CONTAINERS=$(sudo crictl ps -a 2>/dev/null | wc -l)
            if [ "$CONTAINERS" -gt 1 ]; then
              echo "⚠ Warning: Found $((CONTAINERS - 1)) containers still running"
              sudo crictl ps -a || true
            else
              echo "✓ No containers running"
            fi
          fi
          
          echo ""
          echo "=========================================="
          echo "✓✓✓ COMPLETE SUCCESS ✓✓✓"
          echo "=========================================="
          echo ""
          echo "The setup-minikube action:"
          echo "  ✓ Installs and runs minikube successfully"
          echo "  ✓ Properly configures Kubernetes cluster"
          echo "  ✓ Completely restores system state after cleanup"
          echo "  ✓ Can be run multiple times without issues"
          echo "  ✓ Leaves no artifacts after cleanup"
          echo ""
          echo "System state restoration is PERFECT!"
